<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Story ‚Äì Zawla Comic</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="style.css" rel="stylesheet" />

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Page styling (light, modern) -->
  <style>
    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #aee6ff, #dcd0ff, #c8f7c5);
      background-attachment: fixed;
    }
    .story-card {
      max-width: 640px;
      margin: 40px auto;
      border-radius: 20px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.15);
      border: none;
    }
    .story-card h2 {
      font-weight: 700;
      color: #3f37ff;
    }
    .form-label {
      font-weight: 600;
      color: #374151;
    }
    .btn-primary {
      background-color: #4f46e5;
      border-color: #4f46e5;
    }
    .btn-primary:hover {
      background-color: #4338ca;
      border-color: #4338ca;
    }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Zawla Comic</a>
      <a href="index.html" class="btn btn-outline-secondary btn-sm ms-2">üè† Home</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto d-flex align-items-center" id="navList">
          <li class="nav-item">
            <a class="nav-link" id="loginLink" href="login.html">Login</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="#">Create Story</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="library.html">My Library</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="tutorial.html">Tutorial</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- MAIN CONTENT -->
  <div class="container py-5">
    <div class="card story-card bg-white">
      <div class="card-body p-4 p-md-5">
        <h2 class="text-center mb-4">Create Your Story</h2>
        <p class="text-center text-muted mb-4">
          Fill out these options and we‚Äôll help you turn them into a kid-friendly story you can download as a PDF.
        </p>

        <form id="storyForm">
          <!-- NAME -->
          <div class="mb-3 position-relative">
            <label class="form-label">Your Name</label>
            <input type="text" id="userName" class="form-control" placeholder="Enter your name" required />
            <small id="nameWarning" class="text-danger d-none position-absolute" style="bottom:-18px; left:0;">
              ‚ö†Ô∏è Please avoid inappropriate words.
            </small>
          </div>

          <!-- GENRE MULTI-SELECT -->
          <div class="mb-3">
            <label class="form-label">Genre</label>
            <div class="d-flex flex-wrap gap-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="genre" value="Fantasy" id="genreFantasy" checked>
                <label class="form-check-label" for="genreFantasy">Fantasy</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="genre" value="Friendship" id="genreFriendship">
                <label class="form-check-label" for="genreFriendship">Friendship</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="genre" value="Adventure" id="genreAdventure">
                <label class="form-check-label" for="genreAdventure">Adventure</label>
              </div>
            </div>
            <small class="text-muted">You can pick more than one genre.</small>
          </div>

          <!-- PREFERENCES -->
          <div class="mb-3">
            <label class="form-label">Preferences</label>
            <div class="d-flex flex-wrap gap-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="age4">
                <label class="form-check-label" for="age4">4+</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="age5">
                <label class="form-check-label" for="age5">5+</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="age8">
                <label class="form-check-label" for="age8">8+</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="kidFriendly" checked>
                <label class="form-check-label" for="kidFriendly">Kid-friendly</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="filterToggle" checked>
                <label class="form-check-label" for="filterToggle">No bad words</label>
              </div>
            </div>
          </div>

          <!-- LANGUAGE LEVEL -->
          <div class="mb-3">
            <label class="form-label">Language Level</label>
            <select id="langLevel" class="form-select">
              <option value="A1" selected>A1 (Beginner)</option>
              <option value="A2">A2 (Elementary)</option>
              <option value="B1">B1 (Intermediate)</option>
              <option value="B2">B2 (Upper Intermediate)</option>
              <option value="B2+">B2+ (Advanced)</option>
            </select>
          </div>

          <!-- COLOR SCHEME -->
          <div class="mb-3">
            <label class="form-label">Color Scheme (for the PDF)</label>
            <select id="colorScheme" class="form-select">
              <option value="blue" selected>Sky Blue</option>
              <option value="green">Meadow Green</option>
              <option value="purple">Lavender Purple</option>
              <option value="orange">Sunset Orange</option>
            </select>
          </div>

          <!-- STORY LENGTH -->
          <div class="mb-3">
            <label class="form-label">Story Length</label>
            <select id="length" class="form-select">
              <option value="short">Short (1 page)</option>
              <option value="medium">Medium (2 pages)</option>
              <option value="long">Long (3+ pages)</option>
            </select>
          </div>

          <!-- PHOTO UPLOAD -->
          <div class="mb-3">
            <label class="form-label">Upload a Photo</label>
            <input type="file" id="photoInput" accept="image/*" class="form-control" />
            <small class="text-muted">
              This photo will appear only in your story PDF (local only, not uploaded).
            </small>
          </div>

          <div class="text-center mt-3 mb-4">
            <img id="photoPreview" src="" alt="Photo preview"
                 class="img-fluid rounded shadow-sm d-none"
                 style="max-width: 260px;" />
          </div>

          <button type="submit" class="btn btn-primary w-100">Generate Story</button>
          <button id="regenBtn" type="button" class="btn btn-outline-secondary w-100 mt-2 d-none">
            üîÑ Regenerate Story
          </button>
        </form>

        <!-- STORY OUTPUT -->
        <div id="storyOutput" class="mt-4"></div>

        <div class="text-center mt-3">
          <button id="downloadPdfBtn" class="btn btn-success d-none">
            üìÑ Download as PDF
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- FIREBASE INIT + REQUIRE LOGIN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyApQHXAfuTWh_GFsyB7fleGuvxAeODfB1A",
      authDomain: "zawlacomic.firebaseapp.com",
      projectId: "zawlacomic",
      storageBucket: "zawlacomic.firebasestorage.app",
      messagingSenderId: "225177170539",
      appId: "1:225177170539:web:1dea7258f277ffa412b72e"
    };

    const app     = initializeApp(firebaseConfig);
    const auth    = getAuth(app);
    const db      = getFirestore(app);

    // Redirect if not logged in
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("Please sign in first!");
        window.location.href = "index.html";
      } else {
        window.currentUser = user;
      }
    });

    // expose to non-module script (story logic)
    window.db         = db;
    window.addDoc     = addDoc;
    window.collection = collection;
  </script>

  <!-- NAVBAR LOGIN STATE (WELCOME + LOGOUT) -->
  <script type="module">
    import { getAuth, onAuthStateChanged, signOut }
      from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    const auth     = getAuth();
    const loginLink = document.getElementById("loginLink");
    const navList   = document.getElementById("navList");

    // li that will hold "Welcome, name" + logout button
    const userLi = document.createElement("li");
    userLi.classList.add("nav-item", "d-flex", "align-items-center", "ms-3");

    const userSpan = document.createElement("span");
    userSpan.classList.add("fw-semibold", "text-primary", "me-2");

    const logoutBtn = document.createElement("button");
    logoutBtn.textContent = "Logout";
    logoutBtn.classList.add("btn", "btn-outline-danger", "btn-sm");

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    userLi.appendChild(userSpan);
    userLi.appendChild(logoutBtn);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        if (loginLink) {
          loginLink.style.display = "none";
          if (loginLink.parentElement) {
            loginLink.parentElement.style.display = "none";
          }
        }
        const niceName = user.displayName || (user.email ? user.email.split("@")[0] : "User");
        userSpan.textContent = `Welcome, ${niceName}!`;
        navList.appendChild(userLi);
      }
    });
  </script>
  <!-- STORY LOGIC + PDF -->
<script>
  // ===== DOM ELEMENTS =====
  const storyForm       = document.getElementById("storyForm");
  const userNameInput   = document.getElementById("userName");
  const nameWarning     = document.getElementById("nameWarning");
  const filterToggle    = document.getElementById("filterToggle");

  const age4        = document.getElementById("age4");
  const age5        = document.getElementById("age5");
  const age8        = document.getElementById("age8");
  const kidFriendly = document.getElementById("kidFriendly");

  const langLevelSelect   = document.getElementById("langLevel");
  const colorSchemeSelect = document.getElementById("colorScheme");
  const lengthSelect      = document.getElementById("length");

  const photoInput   = document.getElementById("photoInput");
  const photoPreview = document.getElementById("photoPreview");

  const storyOutput    = document.getElementById("storyOutput");
  const regenBtn       = document.getElementById("regenBtn");
  const downloadPdfBtn = document.getElementById("downloadPdfBtn");

  // ===== SIMPLE KID-SAFE FILTER =====
  const bannedWords = [
    "kill","die","dead","blood","sex","naked","drugs","alcohol","weapon",
    "violence","hate","racist","suicide","suicidal","abuse","nsfw","drug"
  ];

  function cleanText(txt) {
    let safe = txt;
    for (const w of bannedWords) {
      const re = new RegExp("\\b" + w + "\\b", "gi");
      safe = safe.replace(re, "***");
    }
    return safe;
  }

  userNameInput.addEventListener("input", () => {
    if (!filterToggle.checked) return;
    const original = userNameInput.value;
    const cleaned  = cleanText(original);

    nameWarning.classList.toggle("d-none", original === cleaned);
    userNameInput.value = cleaned;
  });

  userNameInput.addEventListener("blur", () => {
    nameWarning.classList.add("d-none");
  });

  // ===== GENRE & PREF HELPERS =====
  function getSelectedGenres() {
    return Array.from(document.querySelectorAll('input[name="genre"]:checked'))
      .map(cb => cb.value);
  }

  function getSelectedPreferences() {
    const prefs = [];
    if (age4.checked) prefs.push("4+");
    if (age5.checked) prefs.push("5+");
    if (age8.checked) prefs.push("8+");
    if (kidFriendly.checked) prefs.push("Kid-friendly");
    if (filterToggle.checked)prefs.push("No bad words");
    return prefs;
  }

  // ===== PHOTO PREVIEW =====
  photoInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) {
      photoPreview.classList.add("d-none");
      return;
    }
    const reader = new FileReader();
    reader.onload = ev => {
      photoPreview.src = ev.target.result;
      photoPreview.classList.remove("d-none");
    };
    reader.readAsDataURL(file);
  });

  // ===== FORM SUBMIT: GENERATE STORY =====
  storyForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    let name = userNameInput.value.trim();
    if (filterToggle.checked) name = cleanText(name);

    const genres      = getSelectedGenres();
    const prefs       = getSelectedPreferences();
    const genreText   = genres.length ? genres.join(", ") : "Fantasy";
    const langLevel   = langLevelSelect.value;
    const colorScheme = colorSchemeSelect.value;
    const length      = lengthSelect.value;

    storyOutput.innerHTML = `
      <div class="text-center text-muted">
        <div class="spinner-border text-primary mb-2" role="status"></div>
        <p>Generating your story... please wait</p>
      </div>
    `;

    await new Promise(r => setTimeout(r, 1000));

    const storyHTML = `
      <h4 class="text-primary">‚ú® Your ${genreText} story is ready!</h4>
      <p>
        Once upon a time, <strong>${name}</strong> stepped into a gentle
        ${genreText.toLowerCase()} world. This is a ${length} story at level
        <strong>${langLevel}</strong>, written to stay kind, positive, and kid-friendly.
      </p>
    `;

    storyOutput.innerHTML = storyHTML;
    regenBtn.classList.remove("d-none");
    downloadPdfBtn.classList.remove("d-none");

    // Save to Firdo i iddiestore
    try {
      if (window.db && window.currentUser) {
        const storyData = {
          userId: window.currentUser.uid,
          userName: name,
          genres,
          preferences: prefs,
          length,
          langLevel,
          colorScheme,
          story: storyHTML,
          createdAt: new Date()
        };
        const docRef = await window.addDoc(window.collection(window.db, "stories"), storyData);
        console.log("‚úÖ Story saved with ID:", docRef.id);
      }
    } catch (err) {
      console.error("‚ùå Error saving story:", err);
    }
  });

  // ===== REGENERATE STORY =====
  regenBtn.addEventListener("click", async () => {
    let name = userNameInput.value.trim();
    if (filterToggle.checked) name = cleanText(name);

    const genres      = getSelectedGenres();
    const prefs       = getSelectedPreferences();
    const genreText   = genres.length ? genres.join(", ") : "Fantasy";
    const langLevel   = langLevelSelect.value;
    const colorScheme = colorSchemeSelect.value;
    const length      = lengthSelect.value;
    const variant     = Math.floor(Math.random() * 8999) + 1000;

    storyOutput.innerHTML = `
      <div class="text-center text-muted">
        <div class="spinner-border text-primary mb-2" role="status"></div>
        <p>Creating a new version... please wait</p>
      </div>
    `;

    await new Promise(r => setTimeout(r, 1000));

    let newStory = `
      <h4 class="text-primary">‚ú® Your ${genreText} story (v${variant})</h4>
      <p>
        <strong>${name}</strong> begins another ${genreText.toLowerCase()} adventure.
        This ${length} story at level <strong>${langLevel}</strong> focuses on
        kindness, courage, and learning.
      </p>
    `;
    if (filterToggle.checked) newStory = cleanText(newStory);

    storyOutput.innerHTML = newStory;

    try {
      if (window.db && window.currentUser) {
        const storyData = {
          userId: window.currentUser.uid,
          userName: name,
          genres,
          preferences: prefs,
          length,
          langLevel,
          colorScheme,
          story: newStory,
          createdAt: new Date()
        };
        const docRef = await window.addDoc(window.collection(window.db, "stories"), storyData);
        console.log("üîÑ Regenerated story saved with ID:", docRef.id);
      }
    } catch (err) {
      console.error("‚ùå Error saving regenerated version:", err);
    }
  });

  // ===== PDF DOWNLOAD =====
  downloadPdfBtn.addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });

    const name        = userNameInput.value.trim() || "zawla_story";
    const genres      = getSelectedGenres();
    const genreText   = genres.length ? genres.join(", ") : "Fantasy";
    const langLevel   = langLevelSelect.value;
    const colorScheme = colorSchemeSelect.value;
    const storyText   = storyOutput.innerText.replace(/[^\x00-\x7F]/g, "");

    const palette = {
      blue:   { bg: [240, 246, 255], border: [70, 120, 240], title: [40, 60, 160] },
      green:  { bg: [240, 252, 243], border: [60, 160, 110], title: [35, 120, 85] },
      purple: { bg: [247, 243, 255], border: [125, 95, 200], title: [90, 70, 160] },
      orange: { bg: [255, 248, 238], border: [230, 150, 80], title: [190, 100, 50] }
    };
    const pal = palette[colorScheme] || palette.blue;

    doc.setFillColor(...pal.bg);
    doc.rect(0, 0, 210, 297, "F");

    doc.setDrawColor(...pal.border);
    doc.setLineWidth(1.4);
    doc.rect(5, 5, 200, 287);

    let y = 22;
    doc.setFont("helvetica", "bold");
    doc.setFontSize(22);
    doc.setTextColor(...pal.title);
    doc.text("Zawla Comic Story", 105, y, { align: "center" });

    y += 10;
    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);
    doc.setTextColor(40, 40, 40);
    doc.text(`Author: ${name}`, 20, y);
    y += 6;
    doc.text(`Genre: ${genreText} ‚Ä¢ Level: ${langLevel}`, 20, y);
    y += 10;

    if (photoPreview.src && photoPreview.src.length > 50) {
      doc.addImage(photoPreview.src, "JPEG", 55, y, 100, 70);
      y += 80;
    }

    doc.setFont("times", "normal");
    doc.setFontSize(12);
    const wrapped = doc.splitTextToSize(storyText, 170);
    doc.text(wrapped, 20, y);

    doc.setFontSize(10);
    doc.setTextColor(120, 120, 120);
    doc.text(
      "Generated with Zawla Comic ‚Äì Powered by AI & imagination",
      105,
      285,
      { align: "center" }
    );

    doc.save(`${name}_zawla_story.pdf`);
  });
</script>

</body>
</html>
