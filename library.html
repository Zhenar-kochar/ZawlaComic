<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Library ‚Äì Zawla Comic</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="style.css" rel="stylesheet" />

  <style>
  body {
    background: linear-gradient(180deg, #fdfdfd 0%, #f3f7ff 100%);
  }

  .badge-img {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    transition: transform 0.15s ease;
  }
  .badge-img:hover { transform: scale(1.07); }

  .badge-wrap {
    text-align: center;
  }

  .badge-label {
    display: block;
    margin-top: 6px;
    font-size: 0.9rem;
    color: #555;
  }

  .footer {
    text-align: center;
    margin-top: 60px;
    padding: 20px;
    background: white;
    border-top: 1px solid #eee;
    color: #777;
    font-size: 0.9rem;
  }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Zawla Comic</a>
      <a href="index.html" class="btn btn-outline-secondary btn-sm ms-2">üè† Home</a>

      <div>
        <a href="create.html" class="btn btn-outline-primary btn-sm me-2">Create Story</a>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <div class="container py-5">
    <h2 class="text-center mb-4">üìö My Library</h2>

    <div class="text-center mb-4">
      <h4>üèÖ Your Achievements</h4>
      <div id="badges" class="d-flex justify-content-center flex-wrap gap-3 mt-3"></div>
    </div>

    <div id="storyList" class="row g-3 justify-content-center"></div>
  </div>

  <div class="footer">
    ¬© 2025 Zawla Comic ‚Äì Created by Zhenar Kochar
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyApQHXAfuTWh_GFsyB7fleGuvxAeODfB1A",
      authDomain: "zawlacomic.firebaseapp.com",
      projectId: "zawlacomic",
      storageBucket: "zawlacomic.firebasestorage.app",
      messagingSenderId: "225177170539",
      appId: "1:225177170539:web:1dea7258f277ffa412b72e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const storyList = document.getElementById("storyList");
    const logoutBtn = document.getElementById("logoutBtn");

    // Load stories for current user
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Please sign in first!");
        window.location.href = "login.html";
        return;
      }

      const q = query(collection(db, "stories"), where("userId", "==", user.uid));
      const querySnapshot = await getDocs(q);
      storyList.innerHTML = "";

      let count = 0;

      if (querySnapshot.empty) {
        storyList.innerHTML = `<p class="text-center text-muted">You haven‚Äôt created any stories yet!</p>`;
      } else {
        querySnapshot.forEach((docSnap) => {
          count++;
          const data = docSnap.data();
          const storyId = docSnap.id;
          const date = data.createdAt?.seconds
            ? new Date(data.createdAt.seconds * 1000).toLocaleString()
            : "";

          storyList.innerHTML += `
            <div class="col-md-6 col-lg-4">
              <div class="card shadow-sm p-3 h-100">
                <h5 id="title-${storyId}">${data.userName} ‚Äì <span class="text-secondary">${data.genre}</span></h5>
                <div class="story-text small" style="max-height: 120px; overflow-y:auto;">${data.story}</div>
                <small class="text-muted d-block mt-2">${data.length} ‚Ä¢ ${date}</small>
                <div class="d-flex justify-content-end gap-2 mt-3">
                  <button class="btn btn-sm btn-outline-primary renameBtn" data-id="${storyId}">‚úèÔ∏è Rename</button>
                  <button class="btn btn-sm btn-outline-danger deleteBtn" data-id="${storyId}">üóëÔ∏è Delete</button>
                </div>
              </div>
            </div>
          `;
        });
      }

      showBadges(count);
      enableActions();
    });

    // üèÖ Badge display with your custom images
    function showBadges(count) {
      const badgesDiv = document.getElementById("badges");
      badgesDiv.innerHTML = "";

      if (count === 0) {
        badgesDiv.innerHTML = `<p class="text-muted">No badges yet ‚Äî create your first story to earn one!</p>`;
        return;
      }

      if (count >= 1) {
        badgesDiv.innerHTML += `
          <div class="badge-wrap">
            <img src="1.png" class="badge-img" alt="Story Starter">
            <span class="badge-label">Story Starter</span>
          </div>`;
      }
      if (count >= 5) {
        badgesDiv.innerHTML += `
          <div class="badge-wrap">
            <img src="1-5.png" class="badge-img" alt="Imagination Hero">
            <span class="badge-label">Imagination Hero</span>
          </div>`;
      }
      if (count >= 10) {
        badgesDiv.innerHTML += `
          <div class="badge-wrap">
            <img src="10+.png" class="badge-img" alt="Story Master">
            <span class="badge-label">Story Master</span>
          </div>`;
      }
    }

    // ‚úèÔ∏è Rename + üóëÔ∏è Delete
    function enableActions() {
      document.querySelectorAll(".renameBtn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const titleElement = document.getElementById(`title-${id}`);
          const newName = prompt("Enter a new title:", titleElement.innerText.split("‚Äì")[0].trim());
          if (!newName) return;

          await updateDoc(doc(db, "stories", id), { userName: newName });
          titleElement.innerHTML = `${newName} ‚Äì <span class="text-secondary">Updated</span>`;
          alert("‚úÖ Story renamed!");
        });
      });

      document.querySelectorAll(".deleteBtn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (confirm("Are you sure you want to delete this story?")) {
            await deleteDoc(doc(db, "stories", id));
            btn.closest(".col-md-6").remove();
            alert("üóëÔ∏è Story deleted!");
          }
        });
      });
    }

    // üö™ Logout
    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    });
  </script>
</body>
</html>

